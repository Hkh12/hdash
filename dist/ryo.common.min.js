"use strict";function error(e,t){var n="[ryo"+(t?"":" error")+"] "+e;if(!t)throw new Error(n);console.warn(n)}var alld=[];function register(e,t){e=e.toLowerCase(),/^[a-z]+(?:-?\*)?$/.test(e)||error('invalid directive name "'+e+'"');var n=new RegExp(e.replace(/\*$/,"([a-z]+)")+"$"),r={name:e,expression:n,fn:t};alld.push(r)}function exec(e,t,n){for(var r=null,i=0,s=alld.length;i<s;i++)if(alld[i].expression.test(e)){r=alld[i];break}null===r&&error('directive "'+e+'" not found');var o=e.match(r.expression),a=(o.length,o[1]),c=n.attributes.getNamedItem("r-"+e);r.fn.bind(t)(n,c,a)}function sanitizeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}register("text",function(e,t){var n,r=t.value;r&&this.$_onChange(r,(n=e,function(e){"string"==typeof e&&(e=sanitizeHTML(e).replace(/  /g,"&nbsp;&nbsp;").replace(/\n/g,"<br>")),n.innerHTML=e}),!0)}),register("sync",function(t,e){var n=this;/^(?:INPUT|TEXTAREA)$/.test(t.tagName)||error('<input> or <textarea> required for "sync" directive');var r=e.value;t.addEventListener("keydown",function(){setTimeout(function(){var e="number"===t.type?Number(t.value):t.value;e!==n.state[r]&&(n.state[r]=e)},0)}),this.$_onChange(r,function(e){t.value=e},!0)}),register("on*",function(e,t,n){var r=this,i=/^([a-zA-Z0-9$_]+)(\+\+|--|['"`]|!)?(?:  \| ((?: [a-z]+)+))?$/.exec(t.value),s=i[1],o=i[2],a=i[3],c={},u=void 0===o;"string"==typeof a&&a.trimLeft().split(" ").forEach(function(e){c[a]=!0}),e.addEventListener(n,function(e){if(c.prevent&&e.preventDefault(),u)r.actions[s]();else{if(/'|"|`/.test(o))return r.state[s]="";switch(o){case"--":r.state[s]--;break;case"++":r.state[s]++;break;case"!":r.state[s]=!r.state[s]}}},{once:c.once,passive:c.passive,capture:c.capture})}),register("class-*",function(t,e,n){var r=e.value||n;this.$_onChange(r,function(e){t.classList[e?"add":"remove"](n)},!0)},!0);var Ryo=function(e,t){var n=this;"string"==typeof e?this.el=document.querySelector(e):e instanceof HTMLElement?this.el=e:error("wrong selector or element: expected element or string"),this.state=t.state||{},this.actions=t.actions||{},Object.keys(this.actions).forEach(function(e){n.actions[e]=n.actions[e].bind(n)}),this.$_events={},this.$_init()};Ryo.prototype.$_initStateProxy=function(){var r=this;this.state=new Proxy(this.state,{get:function(e,t){if(t in e)return e[t];error("property "+t+" does'nt exist in state.")},set:function(e,t,n){return t in e||error('property "'+t+"\" does'nt exist in state."),e[t]=n,r.$_emit(t),!0}})},Ryo.prototype.$_emit=function(t){var n=this;t in this.$_events||(this.$_events[t]=[]),this.$_events[t].forEach(function(e){e(n.state[t])})},Ryo.prototype.$_onChange=function(e,t,n){var r=this.$_events[e];void 0===r&&(r=[]),r.push(t),this.$_events[e]=r,n&&this.$_emit(e)},Ryo.prototype.$_init=function(){var n=this;this.$_initStateProxy(),this.el.querySelectorAll("*").forEach(function(t){Array.from(t.attributes).map(function(e){return e.name}).filter(function(e){return/^r-/.test(e)}).forEach(function(e){exec(e.replace(/^r-/,""),n,t)})})},module.exports=Ryo;
