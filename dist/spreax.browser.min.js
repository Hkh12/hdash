var Spreax=function(){function e(e,t){var n="[spreax"+(t?"":" error")+"] "+e;if(!t)throw new Error(n);console.warn(n)}function t(t,n,r){e(t+"\n -------\n(at "+function(e,t){void 0===t&&(t="body"),"string"==typeof t&&(t=document.querySelector(t));for(var n=[];e!==t;)n.unshift(e),e=e.parentElement;return n.unshift(t),(n=n.map(function(e){var t=e.tagName.toLowerCase();return e.className&&(t+="."+e.className.trim().split(" ").join(".")),e.id&&(t+="#"+e.id),t=t.replace(/^div([^$]+)/,"$1")})).join(" > ")}(n)+")",r)}function n(e){for(var t=[],r=0,i=e.childNodes;r<i.length;r+=1){var o=i[r];if(/\S+/g.test(o.textContent)){var a=o.nodeType;a===Node.TEXT_NODE?t.push(o):a===Node.ELEMENT_NODE&&(t=t.concat(n(o)))}}return t}function r(e){return e.replace(/\{ /g,"").replace(/ \}/g,"")}var i=/\{ \w+(?: \| \w+)* \}/gi,o={};function a(t,n,r){void 0===r&&(r="optional"),t in o&&e('directive "'+t+'" already exists'),["optional","empty","required"].includes(r)||e('argument state for directive "'+t+'" is not valid. choosing the default value ("optional")',!0),/^[a-z]+(?:-[a-z]+)*$/.test(t)||e('"'+t+'" is not a valid directive name'),o[t]={argState:r,callback:n}}var c=o,s={null:null,"!0":!0,"!1":!1,false:!1,true:!0,undefined:void 0};a("on",function(e,t,n,r){var i=this,o=/ = .+$/.test(t);e.addEventListener(r,function(e){if(n.prevent&&e.preventDefault(),o){var r=function(e){var t=e.match(/^(.+) = (.+)$/);if(null===t)throw new SyntaxError('string "'+e+'" is not a valid assignment statement');var n=t[1],r=t[2],i=!1;if(r in s)r=s[r];else if(isNaN(Number(r)))if(/^(['"`]).*\1$/.test(r))r=r.slice(1,-1);else{if(!/^\w+$/i.test(r))throw new SyntaxError('could not find any values matching "'+r+'"');i=!0}else r=Number(r);return{prop:n,getValue:function(e){return i?e[r]:r}}}(t);i[r.prop]=r.getValue(i)}else i[t]()},{once:n.once,passive:n.passive,capture:n.capture})},"required"),a("model",{ready:function(e,n,r){var i=this,o=r.lazy;["select","input","textarea"].includes(e.tagName.toLowerCase())||t("model directive only works on input, textarea or select tags",e),"checkbox"===e.type?e.checked=!!this[n]:e.value=this[n],e.addEventListener("change",function(){var t=e.value;"checkbox"===e.type&&(t=e.checked),i[n]=t}),"text"!==e.type||o||e.addEventListener("keydown",function(){setTimeout(function(){i[n]=e.value},0)})},updated:function(e,t){var n="value";"checkbox"===e.type&&(n="checked"),e[n]!==this[t]&&(e[n]=this[t])}},"empty"),a("class",function(e,t,n,r){var i=t||r;this.$on(i,function(n){e.classList[n?"add":"remove"](r||t);var i=e.getAttribute("class");null===i||i.length||e.removeAttribute("class")},{immediate:!0,id:e,type:"DIRECTIVE"})},"required");var u=function t(n,r){this instanceof t||e("Spreax must be called with new operator"),"string"==typeof n?this.$el=document.querySelector(n):n instanceof HTMLElement?this.$el=n:e('wrong selector or element: expected element or string, got "'+String(n)+'"'),this.$events=[],this.$formatters={},this.$_proxy=null,this.$extendWith(r.state||{},r.actions||{},r.computed||{},r.formatters||{}),this.$interpolation(),this.$el.querySelectorAll("*").forEach(this.$execDirectives.bind(this)),this.$observe()};return u.prototype.$extendWith=function(e,t,n,r){var i=this;this.$makeProxy(e),Object.keys(e).forEach(function(e){Object.defineProperty(i,e,{get:function(){return i.$_proxy[e]},set:function(t){i.$_proxy[e]=t}})}),Object.entries(t).forEach(function(e){var t=e[0],n=e[1];i[t]=n.bind(i)}),Object.entries(n).forEach(function(e){var t=e[0],n=e[1];Object.defineProperty(i,t,{get:n.bind(i),set:function(){return!1}})}),Object.entries(r).forEach(function(e){var t=e[0],n=e[1];i.$formatters[t]=n.bind(i)})},u.prototype.$makeProxy=function(t){var n=this;this.$_proxy=new Proxy(t,{get:function(t,n){return t.hasOwnProperty(n)||e('unknown state property "'+n+'"'),t[n]},set:function(t,r,i){return t.hasOwnProperty(r)||e('unknown state property "'+r+'"'),t[r]=i,n.$emit(r),n.$emit(),!0},deleteProperty:function(){return!1}})},u.prototype.$pipeFormatters=function(t){return arguments.length>1?t=Array.prototype.slice.call(arguments):1===arguments.length&&"string"==typeof t&&(t=[t]),function(t,n){return t.length?t.map(function(t){if(t in n)return n[t];e("formatter "+t+" not found")}).reduce(function(e,t){return function(n){return t(e(n))}}):function(e){return e}}(t,this.$formatters).bind(this)},u.prototype.$execDirectives=function(e){var n=this;if(e.attributes&&e.attributes.length)for(var r=function(){var r=o[i],a=r.name,s=r.arg,u=r.modifiers,f=c[a];switch(void 0===f&&t('directive "'+a+'" not found',e),f.argState){case"empty":s&&t('directive "'+a+'" needed no arguments, but there is an argument',e);break;case"required":s||t("directive needs an arguments, but there's nothing",e)}var l=e.getAttribute(function(e){var t="sp-"+e.name;e.arg&&(t+=":"+e.arg);var n=Object.keys(e.modifiers);return n.length&&(t+="."+n.join(".")),t}({name:a,arg:s,modifiers:u})),p=[e,l,u,s];"function"==typeof f.callback?f.callback.apply(n,p):("ready"in f.callback&&f.callback.ready.apply(n,p),"updated"in f.callback&&n.$on("",function(){f.callback.updated.apply(n,p)},{type:"DIRECTIVE",id:e}))},i=0,o=function(e){return Array.from(e.attributes).map(function(e){return e.name}).filter(function(e){return/^sp-/.test(e)}).map(function(e){return e.replace(/^sp-/,"")}).map(function(e){var t,n,r,i=e.match(/^([a-z]+(?:-[a-z]+)*)(:[a-z0-9]+)?((?:\.[a-z0-9]+))*$/),o=i[1],a=i[2],c=i[3];return a&&(a=a.replace(/^:/,"")),c?(t=c.split(".").filter(Boolean),n=!0,r={},t.forEach(function(e){r[e]=n}),c=r):c={},{name:o,arg:a,modifiers:c}}).filter(function(n,r,i){var o=function(e){return e.arg?[e.name,e.arg].join(":"):e.name},a=o(n),c=i.filter(function(e){return o(e)===a});return c.length>1?(t("duplicate directive "+n.name,e,!0),c[0]):n})}(e);i<o.length;i+=1)r()},u.prototype.$interpolation=function(){n(this.$el).forEach(this.$interpolateNode,this)},u.prototype.$interpolateNode=function(e){var t=this;if(n=e.textContent,/\{ \w+(?: \| \w+)* \}/gi.test(n))for(var n,o=e.textContent.match(i).map(r).filter(function(e,t,n){return n.indexOf(e)===t}),a=e.textContent,c=function(){var n=u[s],r=n.split(" | "),i=r[0],o=r.slice(1),c=new RegExp("\\{ "+n.replace(/\|/g,"\\|")+" \\}","g"),f=t.$pipeFormatters(o);t.$on(i,function(t){var n=a.replace(c,f(t));e.textContent!==n&&(e.textContent=n)},{immediate:!0,type:"INTERPOLATION",id:e})},s=0,u=o;s<u.length;s+=1)c()},u.prototype.$observe=function(){var e=this;new MutationObserver(function(t){for(var r=0,i=t;r<i.length;r+=1){for(var o=i[r],a=0,c=o.addedNodes;a<c.length;a+=1){var s=c[a];if("childList"!==o.type||s.nodeType!==Node.TEXT_NODE||!o.target.hasChildNodes(s))switch(s.nodeType){case Node.TEXT_NODE:e.$interpolateNode(s);break;case Node.ELEMENT_NODE:n(s).forEach(e.$interpolateNode,e),e.$execDirectives(s)}}for(var u=0,f=o.removedNodes;u<f.length;u+=1){var l=f[u],p=function(t,n){void 0===n&&(n="INTERPOLATION"),e.$events.filter(function(e){return e.type===n&&e.id===t}).map(function(t){return e.$events.indexOf(t)}).forEach(function(t){e.$events.splice(t,1)})};l.nodeType===Node.TEXT_NODE?p(l):l.nodeType===Node.ELEMENT_NODE&&(n(l).forEach(p),p(l,"DIRECTIVE"))}}}).observe(this.$el,{childList:!0,subtree:!0})},u.prototype.$on=function(e,t,n){void 0===n&&(n={}),this.$events.push({key:e,fn:t,type:n.type,id:n.id}),n.immediate&&this.$emit(e)},u.prototype.$emit=function(e){var t=this;this.$events.filter(function(t){return!e||t.key===e}).forEach(function(e){var n=e.key?[t[e.key]]:[];e.fn.apply(t,n)})},u.directive=a,u}();
