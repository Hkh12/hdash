var Spreax=function(){function e(e,t){var n="[spreax"+(t?"":" error")+"] "+e;if(!t)throw new Error(n);console.warn(n)}function t(t,n,r){e(t+"\n -------\n(at "+function(e,t){void 0===t&&(t="body"),"string"==typeof t&&(t=document.querySelector(t));for(var n=[];e!==t;)n.unshift(e),e=e.parentElement;return n.unshift(t),(n=n.map(function(e){var t=e.tagName.toLowerCase();return e.className&&(t+="."+e.className.trim().split(" ").join(".")),e.id&&(t+="#"+e.id),t=t.replace(/^div([^$]+)/,"$1")})).join(" > ")}(n)+")",r)}var n={};function r(t,r,i){void 0===i&&(i="optional"),t in n&&e('directive "'+t+'" already exists'),["optional","empty","required"].includes(i)||e('argument state for directive "'+t+'" is not valid. choosing the default value ("optional")',!0),/^[a-z]+(?:-[a-z]+)*$/.test(t)||e('"'+t+'" is not a valid directive name'),n[t]={argState:i,callback:r}}var i=n,o={null:null,"!0":!0,"!1":!1,false:!1,true:!0,undefined:void 0};function a(e){for(var t=[],n=0,r=e.childNodes;n<r.length;n+=1){var i=r[n];if(/\S+/g.test(i.textContent)){var o=i.nodeType;o===Node.TEXT_NODE?t.push(i):o===Node.ELEMENT_NODE&&(t=t.concat(a(i)))}}return t}r("on",function(e,t,n,r){var i=this,a=/ = .+$/.test(t);e.addEventListener(r,function(e){if(n.prevent&&e.preventDefault(),a){var r=function(e){var t=e.match(/^(.+) = (.+)$/);if(null===t)throw new SyntaxError('string "'+e+'" is not a valid assignment statement');var n=t[1],r=t[2],i=!1;if(r in o)r=o[r];else if(isNaN(Number(r)))if(/^(['"`]).*\1$/.test(r))r=r.slice(1,-1);else{if(!/^\w+$/i.test(r))throw new SyntaxError('could not find any values matching "'+r+'"');i=!0}else r=Number(r);return{prop:n,getValue:function(e){return i?e[r]:r}}}(t);i[r.prop]=r.getValue(i)}else i[t]()},{once:n.once,passive:n.passive,capture:n.capture})},"required"),r("model",{ready:function(e,n,r){var i=this,o=r.lazy;["select","input","textarea"].includes(e.tagName.toLowerCase())||t("model directive only works on input, textarea or select tags",e),"checkbox"===e.type?e.checked=!!this[n]:e.value=this[n],e.addEventListener("change",function(){i[n]="checkbox"===e.type?e.checked:e.value}),"text"!==e.type||o||e.addEventListener("keydown",function(){setTimeout(function(){i[n]=e.value},0)})},updated:function(e,t){e["checkbox"===e.type?"checked":"value"]=this[t]}},"empty"),r("class",function(e,t,n,r){var i=t||r;this.$on(i,function(n){e.classList[n?"add":"remove"](r||t);var i=e.getAttribute("class");null===i||i.length||e.removeAttribute("class")},{immediate:!0,id:e,type:"DIRECTIVE"})},"required");var c=function t(n,r){this instanceof t||e("Spreax must be called with new operator"),"string"==typeof n?this.$el=document.querySelector(n):n instanceof HTMLElement?this.$el=n:e('wrong selector or element: expected element or string, got "'+String(n)+'"'),this.$events=[],this.$formatters={},this.$_proxy=null,this.$extendWith(r.state||{},r.actions||{},r.computed||{},r.formatters||{}),a(this.$el).forEach(this.$interpolation,this),this.$el.querySelectorAll("*").forEach(this.$execDirectives,this),this.$observe()};return c.prototype.$extendWith=function(e,t,n,r){var i=this;this.$makeProxy(e),Object.keys(e).forEach(function(e){Object.defineProperty(i,e,{get:function(){return i.$_proxy[e]},set:function(t){i.$_proxy[e]=t}})}),Object.entries(t).forEach(function(e){var t=e[0],n=e[1];i[t]=n.bind(i)}),Object.entries(n).forEach(function(e){var t=e[0],n=e[1];Object.defineProperty(i,t,{get:n.bind(i),set:function(){return!1}})}),Object.entries(r).forEach(function(e){var t=e[0],n=e[1];i.$formatters[t]=n.bind(i)})},c.prototype.$makeProxy=function(t){var n=this;this.$_proxy=new Proxy(t,{get:function(t,n){return t.hasOwnProperty(n)||e('unknown state property "'+n+'"'),t[n]},set:function(t,r,i){if(t.hasOwnProperty(r)||e('unknown state property "'+r+'"'),i!==t[r])return t[r]=i,n.$emit(r),n.$emit(),!0},deleteProperty:function(){return!1}})},c.prototype.$pipeFormatters=function(t){return arguments.length>1?t=Array.prototype.slice.call(arguments):1===arguments.length&&"string"==typeof t&&(t=[t]),function(t,n){return t.length?t.map(function(t){if(t in n)return n[t];e("formatter "+t+" not found")}).reduce(function(e,t){return function(n){return t(e(n))}}):function(e){return e}}(t,this.$formatters).bind(this)},c.prototype.$execDirectives=function(e){var n=this;if(e.attributes&&e.attributes.length)for(var r=function(){var r=a[o],c=r.name,s=r.arg,u=r.modifiers,f=i[c];switch(void 0===f&&t('directive "'+c+'" not found',e),f.argState){case"empty":s&&t('directive "'+c+'" needed no arguments, but there is an argument',e);break;case"required":s||t("directive needs an arguments, but there's nothing",e)}var l=e.getAttribute(function(e){var t="sp-"+e.name;e.arg&&(t+=":"+e.arg);var n=Object.keys(e.modifiers);return n.length&&(t+="."+n.join(".")),t}({name:c,arg:s,modifiers:u})),d=[e,l,u,s];"function"==typeof f.callback?f.callback.apply(n,d):("ready"in f.callback&&f.callback.ready.apply(n,d),"updated"in f.callback&&n.$on("",function(){f.callback.updated.apply(n,d)},{type:"DIRECTIVE",id:e}))},o=0,a=function(e){return Array.from(e.attributes).map(function(e){return e.name}).filter(function(e){return/^sp-/.test(e)}).map(function(e){return e.replace(/^sp-/,"")}).map(function(e){var t,n,r,i=e.match(/^([a-z]+(?:-[a-z]+)*)(:[a-z0-9]+)?((?:\.[a-z0-9]+))*$/),o=i[1],a=i[2],c=i[3];return a&&(a=a.replace(/^:/,"")),c?(t=c.split(".").filter(Boolean),n=!0,r={},t.forEach(function(e){r[e]=n}),c=r):c={},{name:o,arg:a,modifiers:c}}).filter(function(n,r,i){var o=function(e){return e.arg?[e.name,e.arg].join(":"):e.name},a=o(n),c=i.filter(function(e){return o(e)===a});return c.length>1?(t("duplicate directive "+n.name,e,!0),c[0]):n})}(e);o<a.length;o+=1)r()},c.prototype.$interpolation=function(e){var t=this;!function(e,t){var n=/\{\{ ?\w+(?: \| \w+)* ?\}\}/gi,r=e.textContent;if(n.test(r)){var i=[];r.replace(n,function(e,t){return i.push({string:e,startIndex:t}),e});for(var o=0,a=i;o<a.length;o+=1){var c=a[o],s=c.string,u=c.startIndex,f=s.replace(/^\{\{ ?/,"").replace(/ ?\}\}$/,"").split(" | "),l=f[0];t({initialText:r,node:e,formatters:f.slice(1),match:{startIndex:u,string:s},propertyName:l})}}}(e,function(e){var n=e.initialText,r=e.node,i=e.propertyName,o=e.formatters,a=e.match,c=a.startIndex,s=a.string,u=t.$pipeFormatters(o);t.$on(i,function(e){e=String(u(e));var t=n.slice(0,c)+e+n.slice(c+s.length+e.length,n.length);n!==t&&(r.textContent=t)},{immediate:!0,type:"INTERPOLATION",id:r})})},c.prototype.$observe=function(){var e=this;new MutationObserver(function(t){for(var n=0,r=t;n<r.length;n+=1){for(var i=r[n],o=0,c=i.addedNodes;o<c.length;o+=1){var s=c[o];if("childList"!==i.type||s.nodeType!==Node.TEXT_NODE||!i.target.hasChildNodes(s))switch(s.nodeType){case Node.TEXT_NODE:e.$interpolateNode(s);break;case Node.ELEMENT_NODE:a(s).forEach(e.$interpolation,e),e.$execDirectives(s)}}for(var u=0,f=i.removedNodes;u<f.length;u+=1){var l=f[u],d=function(t,n){void 0===n&&(n="INTERPOLATION"),e.$events.filter(function(e){return e.type===n&&e.id===t}).map(function(t){return e.$events.indexOf(t)}).forEach(function(t){e.$events.splice(t,1)})};l.nodeType===Node.TEXT_NODE?d(l):l.nodeType===Node.ELEMENT_NODE&&(a(l).forEach(d),d(l,"DIRECTIVE"))}}}).observe(this.$el,{childList:!0,subtree:!0})},c.prototype.$on=function(e,t,n){void 0===n&&(n={}),this.$events.push({key:e,fn:t,type:n.type,id:n.id}),n.immediate&&this.$emit(e)},c.prototype.$emit=function(e){var t=this;this.$events.filter(function(t){return!e||t.key===e}).forEach(function(e){var n=e.key?[t[e.key]]:[];e.fn.apply(t,n)})},c.directive=r,c}();
